# Release Notes: v1.4.1

**Release Date:** November 30, 2025

## Overview

Version 1.4.1 is a bug fix release that resolves an inconsistency issue in the relay capability testing functions where RTT (Round-Trip Time) values could be non-None while their corresponding capability flags were False, causing `Nip66ValidationError`.

## What's Changed

### Bug Fix: RTT and Capability Flag Consistency

The `check_readability`, `check_writability`, and `check_connectivity` functions in `actions/actions.py` could potentially return non-None RTT values while their corresponding capability flags were False. This violated the Nip66 validation rules and caused `Nip66ValidationError`.

#### Root Cause

In `check_readability`, the `rtt_read` value was set when the first message was received, before checking what type of message it was. If the relay responded with a `CLOSED` message (rejecting the subscription), the function would exit with:
- `rtt_read = <measured time>` (time to receive the CLOSED message)
- `readable = False` (subscription was rejected)

This combination failed Nip66 validation which enforces:
```python
if not flag_value and rtt_value is not None:
    raise Nip66ValidationError(f"{rtt_name} must be None when {flag_name} is False")
```

#### The Fix

Added defensive consistency checks at the end of all three functions to ensure RTT values are set to None when their corresponding capability flags are False:

**check_connectivity:**
```python
# Ensure consistency - if not openable, rtt_open must be None
if not openable:
    rtt_open = None
```

**check_readability:**
```python
# Ensure consistency - if not readable, rtt_read must be None
if not readable:
    rtt_read = None
```

**check_writability:**
```python
# Ensure consistency - if not writable, rtt_write must be None
if not writable:
    rtt_write = None
```

### Risk Assessment

| Function | Risk Before Fix | Reason |
|----------|-----------------|--------|
| `check_readability` | HIGH | RTT set on first message before type check |
| `check_writability` | LOW | RTT set after successful publish, but no defensive check |
| `check_connectivity` | LOW | RTT set inside success block, but no defensive check |

## Migration Guide

### From v1.4.0 to v1.4.1

This is a **bug fix release**. All code that worked in v1.4.0 will continue to work in v1.4.1.

#### No Changes Required

Simply upgrade to v1.4.1 to get the fix:

```bash
pip install --upgrade nostr-tools==1.4.1
```

#### Affected Use Cases

If you were experiencing `Nip66ValidationError` when testing relay capabilities with relays that:
- Accept WebSocket connections but reject subscriptions with CLOSED messages
- Have intermittent connectivity issues

These issues should now be resolved.

## Technical Details

### Modified Files

1. **actions.py** (`src/nostr_tools/actions/actions.py`)
   - Added consistency check in `check_connectivity()` (lines 359-361)
   - Added consistency check in `check_readability()` (lines 412-414)
   - Added consistency check in `check_writability()` (lines 479-481)

### Code Changes Summary

**Lines Changed**: +9/-0
- 9 lines added (3 consistency checks with comments)

### Test Coverage

- **Total Tests**: 541
- **Coverage**: 80%+ maintained
- **Type Checking**: All MyPy checks pass
- **Code Quality**: All Ruff checks pass
- **Security**: All security scans pass (Bandit, Safety, pip-audit)

## Compatibility

### Python Versions

Supports Python 3.9, 3.10, 3.11, 3.12, and 3.13.

### Dependencies

No dependency changes in this release.

### Breaking Changes

**None**. This release is fully backward compatible with v1.4.0.

## Upgrade Instructions

### Using pip

```bash
pip install --upgrade nostr-tools==1.4.1
```

### Using poetry

```bash
poetry add nostr-tools@^1.4.1
```

### Verify Installation

```python
import nostr_tools
print(nostr_tools.__version__)  # Should print: 1.4.1
```

## Examples

### Testing Relay Capabilities (Now Works Correctly)

```python
from nostr_tools import Client, Relay
from nostr_tools.actions import fetch_nip66, check_readability

# Test a relay that might reject subscriptions
relay = Relay("wss://relay.example.com")
client = Client(relay)

# This now works correctly even if the relay rejects subscriptions
# Previously could raise Nip66ValidationError
nip66 = await fetch_nip66(client, private_key, public_key)

if nip66:
    print(f"Openable: {nip66.openable}, RTT: {nip66.rtt_open}")
    print(f"Readable: {nip66.readable}, RTT: {nip66.rtt_read}")
    print(f"Writable: {nip66.writable}, RTT: {nip66.rtt_write}")
```

## Known Issues

None.

## Support

### Supported Versions

| Version | Support Status | End of Support |
|---------|----------------|----------------|
| 1.4.1   | Active         | TBD            |
| 1.4.0   | EOL            | 2025-11-30     |
| <= 1.3.0 | EOL           | Earlier        |

### Getting Help

- **Documentation**: [https://bigbrotr.github.io/nostr-tools/](https://bigbrotr.github.io/nostr-tools/)
- **Issues**: [https://github.com/bigbrotr/nostr-tools/issues](https://github.com/bigbrotr/nostr-tools/issues)
- **PyPI**: [https://pypi.org/project/nostr-tools/](https://pypi.org/project/nostr-tools/)

## Contributors

This release was made possible by the nostr-tools development team.

## Changelog

For a complete list of changes, see [CHANGELOG.md](../CHANGELOG.md).

---

**Full Changelog**: v1.4.0...v1.4.1
